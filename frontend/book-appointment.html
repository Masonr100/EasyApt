<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment - EasyApt</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="nav">
    <div class="container">
      <div class="nav-links">
        <span class="nav-brand">EasyApt</span>
        <a href="/">Home</a>
        <a href="/appointments.html">My Appointments</a>
        <a href="/book-appointment.html">Book Appointment</a>
        <a href="/profile.html">My Profile</a>
        <a href="#" id="logout-link">Logout</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="card">
      <div class="card-header">
        <h1 class="card-title">Book an Appointment</h1>
        <p class="text-muted">Search for a provider and select an available time slot</p>
      </div>

      <div class="card mb-3">
        <h2 style="margin-bottom: 12px;">Step 1: Find a Provider</h2>
        
        <div class="form-group">
          <label for="provider-query" class="form-label">Search by provider name</label>
          <div style="display: flex; gap: 8px;">
            <input 
              type="text" 
              id="provider-query" 
              class="form-input" 
              placeholder="e.g., Dr. Smith, Johnson"
              style="flex: 1;"
            />
            <button id="search-btn" class="btn btn-primary">Search</button>
          </div>
        </div>

        <div id="search-message" class="hidden"></div>
        <div id="provider-results"></div>
      </div>

      <div id="calendar-section" class="card hidden">
        <h2 style="margin-bottom: 12px;">Step 2: Choose Date & Time</h2>
        <h3 id="selected-provider-name" style="color: var(--primary-color); margin-bottom: 16px;"></h3>

        <div class="form-group">
          <label for="date-picker" class="form-label">Select a date</label>
          <input 
            type="date" 
            id="date-picker" 
            class="form-input" 
            style="max-width: 300px;"
          />
        </div>

        <div id="calendar-message" class="hidden"></div>
        
        <div id="slots-container" class="slots-grid"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { 
      providers, 
      appointments, 
      auth,
      requireAuth, 
      showError, 
      showSuccess, 
      showInfo 
    } from './js/api.js';

    if (!requireAuth()) {
      throw new Error('Not authenticated');
    }

    const searchInput = document.getElementById('provider-query');
    const searchBtn = document.getElementById('search-btn');
    const searchMessage = document.getElementById('search-message');
    const providerResults = document.getElementById('provider-results');
    const calendarSection = document.getElementById('calendar-section');
    const selectedProviderName = document.getElementById('selected-provider-name');
    const datePicker = document.getElementById('date-picker');
    const calendarMessage = document.getElementById('calendar-message');
    const slotsContainer = document.getElementById('slots-container');
    const logoutLink = document.getElementById('logout-link');

    let selectedProvider = null;
    let providerAppointments = [];

    const timeSlots = [
      '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
      '13:00', '13:30', '14:00', '14:30', '15:00', '15:30',
      '16:00', '16:30'
    ];

    logoutLink.addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('Are you sure you want to logout?')) {
        auth.logout();
      }
    });

    function getTodayDate() {
      const today = new Date();
      return today.toISOString().split('T')[0];
    }

    async function searchProviders() {
      const query = searchInput.value.trim();
      
      if (!query) {
        showError('search-message', 'Please enter a provider name to search');
        return;
      }

      searchBtn.disabled = true;
      searchBtn.textContent = 'Searching...';
      showInfo('search-message', 'Searching for providers...');
      providerResults.innerHTML = '';
      calendarSection.classList.add('hidden');

      try {
        const results = await providers.search(query);

        searchBtn.disabled = false;
        searchBtn.textContent = 'Search';

        if (!results || results.length === 0) {
          showError('search-message', 'No providers found. Try a different search term.');
          return;
        }

        searchMessage.classList.add('hidden');
        
        providerResults.innerHTML = '<h3 style="margin: 16px 0 12px 0;">Search Results:</h3>';
        
        results.forEach(provider => {
          const card = document.createElement('div');
          card.className = 'provider-card';
          
          const nameDiv = document.createElement('div');
          nameDiv.className = 'provider-name';
          nameDiv.textContent = provider.name;
          
          const specialtyDiv = document.createElement('div');
          specialtyDiv.className = 'provider-specialty';
          specialtyDiv.textContent = provider.specialty || 'General Practice';
          
          const selectBtn = document.createElement('button');
          selectBtn.className = 'btn btn-primary btn-sm';
          selectBtn.textContent = 'Select Provider';
          selectBtn.addEventListener('click', () => selectProvider(provider));
          
          card.appendChild(nameDiv);
          card.appendChild(specialtyDiv);
          card.appendChild(selectBtn);
          
          providerResults.appendChild(card);
        });

      } catch (error) {
        console.error('Search error:', error);
        showError('search-message', error.message || 'Error searching providers');
        searchBtn.disabled = false;
        searchBtn.textContent = 'Search';
      }
    }

    async function selectProvider(provider) {
      selectedProvider = provider;
      selectedProviderName.textContent = `Booking with ${provider.name}`;
      
      calendarSection.classList.remove('hidden');
      calendarSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      showInfo('calendar-message', 'Loading available time slots...');
      slotsContainer.innerHTML = '';

      if (!datePicker.value) {
        datePicker.value = getTodayDate();
      }

      try {
        providerAppointments = await providers.getAppointments(provider.id);
        calendarMessage.classList.add('hidden');
        renderSlots();

      } catch (error) {
        console.error('Error loading appointments:', error);
        showError('calendar-message', 'Error loading available slots. Showing all times as available.');
        providerAppointments = [];
        renderSlots();
      }
    }

    function renderSlots() {
      const selectedDate = datePicker.value;
      
      if (!selectedDate) {
        showError('calendar-message', 'Please select a date');
        return;
      }

      slotsContainer.innerHTML = '';

      timeSlots.forEach(timeStr => {
        const slotDiv = document.createElement('div');
        slotDiv.className = 'slot';
        
        const startTime = `${selectedDate}T${timeStr}:00`;
        
        const isBooked = providerAppointments.some(appt => 
          appt.status === 'booked' && 
          appt.start_time && 
          appt.start_time.startsWith(`${selectedDate}T${timeStr}`)
        );
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'slot-time';
        timeDiv.textContent = formatTime(timeStr);
        
        const statusDiv = document.createElement('div');
        statusDiv.className = 'slot-status';
        
        if (isBooked) {
          slotDiv.classList.add('slot-booked');
          statusDiv.textContent = 'Booked';
        } else {
          slotDiv.classList.add('slot-available');
          statusDiv.textContent = 'Available';
          slotDiv.style.cursor = 'pointer';
          slotDiv.addEventListener('click', () => bookSlot(startTime));
        }
        
        slotDiv.appendChild(timeDiv);
        slotDiv.appendChild(statusDiv);
        slotsContainer.appendChild(slotDiv);
      });
    }

    function formatTime(timeStr) {
      const [hours, minutes] = timeStr.split(':');
      const hour = parseInt(hours);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour > 12 ? hour - 12 : hour === 0 ? 12 : hour;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    async function bookSlot(startTime) {
      const reason = prompt('Please enter the reason for your appointment:', '');
      if (reason === null) {
        return;
      }
      if (!reason || reason.trim() === '') {
        showError('calendar-message', 'Please provide a reason for your appointment');
        return;
      }

      if (!confirm(`Book appointment for ${formatDateTime(startTime)}?`)) {
        return;
      }

      showInfo('calendar-message', 'Booking appointment...');

      try {
        const startDate = new Date(startTime);
        const endDate = new Date(startDate.getTime() + 30 * 60000);
        const endTime = endDate.toISOString().slice(0, 19);

        await appointments.book(selectedProvider.id, startTime, endTime, reason.trim());
        
        showSuccess('calendar-message', 'Appointment booked successfully! Redirecting...');
        
        setTimeout(() => {
          window.location.href = '/appointments.html';
        }, 2000);

      } catch (error) {
        console.error('Booking error:', error);
        showError('calendar-message', error.message || 'Error booking appointment');
      }
    }

    function formatDateTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      });
    }

    searchBtn.addEventListener('click', searchProviders);
    
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchProviders();
      }
    });

    datePicker.addEventListener('change', renderSlots);

    datePicker.min = getTodayDate();
  </script>
</body>
</html>
